<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.zzzy.basemapper.activitymapper.ActivityMapper">
		<resultMap type="cn.com.zzzy.entity.Activity" id="activityResult">
			<id column="activity_Id" property="activityId"></id>
			<result column="activity_Name" property="activityName"></result>
			<result column="activity_beginTime" property="activityBeginTime"></result>
			<result column="activity_endTime"  property="activityEndTime"></result>
			<result column="activity_Flag"   property="activityFlag"></result>
			<result column="activity_appliReason" property="activityAppliReason"></result>
			<result column="activity_appliTime" property="activityAppliTime"></result>
			<result column="activityPhoto" property="activityPhoto"></result>
			<association column="activity_typeId" property="activityType"  javaType="cn.com.zzzy.entity.ActivityType" resultMap="activityTypeResult"></association>
			<association column="activity_appliStuId" property="student" javaType="cn.com.zzzy.entity.Student" resultMap="studentResult"></association>
			<association column="activity_launchId"  property="activityLaunch" javaType="cn.com.zzzy.entity.ActivityLaunch" resultMap="activityLaunchResult"></association>
			<collection property="activityStudents" ofType="cn.com.zzzy.entity.ActivityStudent">
						<id column="activity_studentId"  property="activityStudentsId"></id>
						<result column="stu_activityFlag" property="stuActivityFlag"></result>
						<result column="stu_messageId" property="stuMessageId"></result>
						<association column="stus_Id"  property="students" resultMap="studentsResult" javaType="cn.com.zzzy.entity.Student"/>
						
			</collection>
			<collection property="activityRecords" ofType="cn.com.zzzy.entity.ActivityRecord"  resultMap="activityRecordResult" />
		</resultMap>
		
		<resultMap id="activityTypeResult" type="cn.com.zzzy.entity.ActivityType">
				<id column="activity_typeId" property="activityTypeId"></id>
				<result column="activity_typeName"  property="activityTypeName"></result>
				<association  column="community_Id" property="community"  resultMap="communityResult"></association>
		</resultMap>
		
		<resultMap id="studentResult" type="cn.com.zzzy.entity.Student">
				<id column="stu_Id" property="studentId"></id>
				<result column="stu_Name" property="studentName"></result>
				<result column="stu_Sex"  property="studentSex"></result>
				<result column="stu_Birthday"  property="studentBirthday"></result>
				<result column="stu_Address" property="studentAddress"></result>
				<result column="stu_BirthPlace"  property="studentBirthPlace"></result>
				<result column="stu_Photo"  property="studentPhoto"></result>
		</resultMap>
		<resultMap id="studentsResult" type="cn.com.zzzy.entity.Student">
				<id column="stusId" property="studentId"></id>
				<result column="activityStuName" property="studentName"></result>
				<result column="activityStudentPhoto"  property="studentPhoto"></result>
		</resultMap>
		
		<resultMap id="activityRecordResult" type="cn.com.zzzy.entity.ActivityRecord">
				<id column="activityRecordId"  property="activityRecordId"></id>
				<result column="activity_recordContent"  property="activityRecordContent"></result>
				<result column="activity_recordTime" property="activityRecordTime"></result>
				<collection property="activityRecordPhotos" ofType="cn.com.zzzy.entity.ActivityRecordPhoto">
						<id column="activity_record_PhotoId" property="activityPhotoId"></id>
						<result column="activity_record_photo" property="activityRecordPhoto" />
				</collection>
		</resultMap>
		
		<resultMap id="activityLaunchResult" type="cn.com.zzzy.entity.ActivityLaunch">
				<id column="activity_lanId" property="activityLaunchId"></id>
				<result  column="activity_lanDesc"  property="activityLaunchDesc"/>
				<result  column="activity_perNum"  property="activityPersonNum"/>
				<result  column="activity_regisCon"  property="activityRegisterCond"/>
				<collection resultMap="activityLaunchPhoto" property="activityLaunchPhoto" ofType="cn.com.zzzy.entity.ActivityLaunchPhoto" ></collection>
		</resultMap>
		
		<resultMap id="activityLaunchPhoto" type="cn.com.zzzy.entity.ActivityLaunchPhoto">
				<id column="activity_launch_photoId" property="activityLaunchPhotoId"></id>
				<result column="activity_launch_Id" property="activityLaunchId"></result>
				<result column="activity_launch_photos" property="activityLaunchPhotos"></result>
		</resultMap>
		
		<resultMap id="communityResult" type="cn.com.zzzy.entity.Community">
				<id column="community_Id"  property="communityId"></id>
				<result  column="community_Name"  property="communityName"/>
				<result  column="community_appliRespon"  property="communityAppliRespon" ></result>
		</resultMap>
		
		
		<!--根据 学生ID,活动状态,活动类型,活动名称 查询活动-->
		<select id="queryActivityByCondition"  resultMap="activityResult">
					select a.*,t.*,s.*,l.* from activity a  left join activity_type t
						on t.activity_typeId = a.activity_typeId left join stu s
						on s.stu_Id = a.activity_appliStuId  left  join activity_launch l
						on l.activity_lanId = a.activity_launchId
						<where>
						       1 = 1 
								<if test="aqv!=null  and  aqv.activityInfo !=null and aqv.activityInfo.activityFlag!=null">
									 and	 a.activity_Flag = #{aqv.activityInfo.activityFlag}
								</if>
								<if test=" aqv!=null  and  aqv.activityInfo !=null  and aqv.activityInfo.activityApplyStuId!=null">
										  and a.activity_appliStuId  = #{aqv.activityInfo.activityApplyStuId}
								</if>
								<if test="aqv!=null  and  aqv.activityInfo !=null and aqv.activityInfo.activityTypeId !=null">
										  and a.activity_typeId = #{aqv.activityInfo.activityTypeId}
								</if>
								<if test="aqv!=null  and  aqv.activityInfo !=null and aqv.activityInfo.activityName !=null">
										  and a.activity_Name = #{aqv.activityInfo.activityName}
								</if>
								<!-- 后台根据活动状态查询 -->
								<if test="param!=null and param.flag!=null">
									 and	a.activity_Flag = #{param.flag}
								</if>	
								<!-- 后台模糊查询使用 -->
								<if test="param!=null and param.keyWord!=null">
									and (a.activity_Name like concat('%',concat(#{param.keyWord},'%')) or t.activity_typeName like concat('%',concat(#{param.keyWord},'%')) or s.stu_Name like concat('%',concat(#{param.keyWord},'%'))) 
								</if>
								
						</where>
						order by a.activity_Id 
						limit #{param.startIndex},#{param.rows}
		</select>
		<!-- 根据学生ID,活动状态,活动类型,活动名称 查询活动的数量 -->
		<select id="queryActivityAcountByCondition"    resultType="Integer">
					select count(*) from activity a  left join activity_type t
				on t.activity_typeId = a.activity_typeId left join stu s
				on s.stu_Id = a.activity_appliStuId  left  join activity_launch l
				on l.activity_lanId = a.activity_launchId 
				<where>
				     1 = 1
						<if test=" aqv!=null and aqv.activityInfo !=null and aqv.activityInfo.activityFlag!=null">
								 and a.activity_Flag = #{aqv.activityInfo.activityFlag}
						</if>
						<if test=" aqv!=null and aqv.activityInfo !=null  and aqv.activityInfo.studentId!=null">
								  and a.activity_appliStuId  = #{aqv.activityInfo.studentId}
						</if>
						<if test=" aqv!=null and  aqv.activityInfo !=null and aqv.activityInfo.activityTypeId">
								  and a.activity_typeId = #{aqv.activityInfo.activityTypeId}
						</if>
						<if test=" aqv!=null and  aqv.activityInfo !=null and aqv.activityInfo.activityName !=null">
								  and a.activity_Name = #{aqv.activityInfo.activityName}
						</if>
						<if test="param!=null and param.flag!=null">
								 and a.activity_Flag = #{param.flag}
						</if>						
						<if test="param!=null and param.keyWord!=null">
								and (a.activity_Name like concat('%',concat(#{param.keyWord},'%')) or t.activity_typeName like concat('%',concat(#{param.keyWord},'%')) or s.stu_Name like concat('%',concat(#{param.keyWord},'%'))) 
						</if>	
						
			</where>			
		</select>
		
		
		
		<!--查询朋友圈的活动 -->
		<select id="queryActivityByFriendIds" resultMap="activityResult">
				select  a.*,t.*,s.* from activity a  left join activity_type t
						on t.activity_typeId = a.activity_typeId left join stu s
						on s.stu_Id = a.activity_appliStuId  left  join activity_launch l
						on l.activity_lanId = a.activity_launchId 
						where   a.activity_Flag = 3  and   a.activity_appliStuId in
						(		SELECT
										sf.frientId
									FROM
										stu_friend sf
									WHERE
										sf.stuId = #{stuId}
									AND sf.stu_friend_Flag = 1)
						order by a.activity_Id 
						limit #{param.startIndex},#{param.rows}
		</select>
		<!--查看朋友圈活动的数量-->
		<select id="queryActivityCountByFriendIds" resultType="Integer">
	     select     a.*,s.*,activity_type.*,community.*,activity_student.*,activity_launch.*,activity_record.*
	     			,ss.stu_Id as stusId,ss.stu_Name as activityStuName,ss.stu_Photo as activityStudentPhoto from activity  a left join stu  s
					on s.stu_Id = a.activity_appliStuId  left  join  activity_type
					on activity_type.activity_typeId = a.activity_typeId  left join  community
					on  activity_type.community_Id = community.community_Id left join activity_student
					on activity_student.activity_Id = a.activity_Id   left join stu  ss 
					on  ss.stu_Id = activity_student.stus_Id   left join activity_launch
					on a.activity_launchId = activity_launch.activity_lanId   left join  activity_record
				    on  a.activity_Id = activity_record.activity_Id left join activity_record_photo 
					on   activity_record.activity_recordId = activity_record_photo.activity_recordId
						where   a.activity_Flag = 0   and   a.activity_appliStuId in
						(		SELECT
										sf.frientId
									FROM
										stu_friend sf
									WHERE
										sf.stuId = #{stuId}
									AND sf.stu_friend_Flag = 1)
		</select>
		
		<!-- 查询学生参加的活动 -->
		<select id="queryMyJoinActivity" resultMap="activityResult">
					select * from  activity  a
					left join activity_student  s
					on a.activity_Id  = s.activity_Id   where s.stus_Id   = #{stuId}   and s.stu_activityFlag = 1
		</select>
		
		<!-- 根据活动ID查询活动的详细信息 -->
		<select id="queryActivityDetail" resultMap="activityResult">
				SELECT
					a.*, s.*, activity_type.*, community.*, activity_student.*, activity_launch.*,activity_launch_photo.*,
				  activity_record.activity_recordId activityRecordId,
				  activity_record.activity_recordContent,
				  activity_record.activity_recordTime,
					activity_record_photo.*,
					ss.stu_Id AS stusId,
					ss.stu_Name AS activityStuName,
					ss.stu_Photo AS activityStudentPhoto
				FROM
					activity a
				LEFT JOIN stu s ON s.stu_Id = a.activity_appliStuId
				LEFT JOIN activity_type ON activity_type.activity_typeId = a.activity_typeId
				LEFT JOIN community ON activity_type.community_Id = community.community_Id
				LEFT JOIN activity_student ON activity_student.activity_Id = a.activity_Id
				LEFT JOIN stu ss ON ss.stu_Id = activity_student.stus_Id
				LEFT JOIN activity_launch ON a.activity_launchId = activity_launch.activity_lanId
				LEFT JOIN activity_launch_photo ON activity_launch_photo.activity_launch_Id = activity_launch.activity_lanId 
				LEFT JOIN activity_record ON a.activity_Id = activity_record.activity_Id
				LEFT JOIN activity_record_photo ON activity_record.activity_recordId = activity_record_photo.activity_recordId
					<where>
								a.activity_Id = #{activityId}
					</where>
		</select>
		
		
		
		<!--申请活动-->
		<insert id="insertActivity"  parameterType="cn.com.zzzy.entity.ActivityQueryVo">
			insert into activity(activity_Name,activity_beginTime,activity_endTime,activity_appliTime,activity_appliReason,activity_typeId,activity_appliStuId,activityPhoto) values(#{obj.activityInfo.activityName},#{obj.activityInfo.activityBeginTime},#{obj.activityInfo.activityEndTime},NOW(),#{obj.activityInfo.activityAppliReason},#{obj.activityInfo.activityTypeId},#{obj.activityInfo.studentId},#{obj.activityInfo.activityPhoto})
		</insert>
		
		<!-- 更新活动状态  -->
		<update id="updateActivityFlag">
		   update activity a set a.activity_Flag = #{aqv.activityFlag} WHERE a.activity_Id =#{aqv.activityId}
		</update>
		
		
		<update id="updateActivityLaunchId">
			update activity  set activity.activity_launchId =#{activityLaunchId}  where  activity.activity_Id = #{activityId}
		</update>
		
		
</mapper>